<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Generic Types - The Dwarf Programming Language</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../.././mdbook-admonish.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <img class="sidebar-logo" src="../../favicon.png">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><a href="../../overview.html">Language Walkthrough</a></li><li class="chapter-item expanded affix "><li class="part-title">Examples</li><li class="chapter-item expanded "><a href="../../tutorials/mandelbrot.html"><strong aria-hidden="true">1.</strong> Mandelbrot Set</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../tutorials/mandelbrot/complex.html"><strong aria-hidden="true">1.1.</strong> Coding a Complex Type</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.2.</strong> Mapping Points to Pixels</div></li><li class="chapter-item expanded "><a href="../../tutorials/mandelbrot/render_0.html"><strong aria-hidden="true">1.3.</strong> Rendering the Set</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.4.</strong> Speeding it up</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Python Bindings</div></li><li class="chapter-item expanded affix "><li class="part-title">Reference</li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Dwarf Language Reference</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">3.1.</strong> Items</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../reference/enums.html"><strong aria-hidden="true">3.1.1.</strong> Enumerations</a></li><li class="chapter-item expanded "><a href="../../reference/functions.html"><strong aria-hidden="true">3.1.2.</strong> Functions</a></li><li class="chapter-item expanded "><a href="../../reference/imports.html"><strong aria-hidden="true">3.1.3.</strong> Imports</a></li><li class="chapter-item expanded "><a href="../../reference/patterns.html"><strong aria-hidden="true">3.1.4.</strong> Patterns</a></li><li class="chapter-item expanded "><a href="../../reference/structs.html"><strong aria-hidden="true">3.1.5.</strong> Structs</a></li></ol></li><li class="chapter-item expanded "><a href="../../reference/statements.html"><strong aria-hidden="true">3.2.</strong> Statements</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.3.</strong> Expressions</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../reference/expressions/literal.html"><strong aria-hidden="true">3.3.1.</strong> Literal Expressions</a></li><li class="chapter-item expanded "><a href="../../reference/expressions/unary.html"><strong aria-hidden="true">3.3.2.</strong> Unary Expressions</a></li><li class="chapter-item expanded "><a href="../../reference/expressions/binary.html"><strong aria-hidden="true">3.3.3.</strong> Binary Expressions</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.4.</strong> Types</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../reference/built-in-types.html"><strong aria-hidden="true">3.4.1.</strong> Built-in Types</a></li><li class="chapter-item expanded "><a href="../../reference/udts.html"><strong aria-hidden="true">3.4.2.</strong> User-defined Types</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.5.</strong> Inline Assembly</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.6.</strong> Object Oriented Features</div></li></ol></li><li class="chapter-item expanded "><a href="../../chacha.html"><strong aria-hidden="true">4.</strong> ChaCha Runtime Reference</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> The Future</div></li><li class="chapter-item expanded "><a href="../../hacker.html"><strong aria-hidden="true">6.</strong> For Hackers</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">6.1.</strong> Building</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">6.1.1.</strong> Tools</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.1.2.</strong> Benchmarks</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.2.</strong> Architecture</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../hacker/arch/parser.html"><strong aria-hidden="true">6.2.1.</strong> Parser</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.2.2.</strong> Compiler</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.2.3.</strong> Chacha</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../hacker/arch/chacha/async.html"><strong aria-hidden="true">6.2.3.1.</strong> Async Implementation</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.2.3.2.</strong> Interpreter</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.2.3.3.</strong> VM</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.2.4.</strong> The ObjectStore</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.3.</strong> Code Generation</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.4.</strong> Dwarf Language</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../hacker/dwarf/generics.html" class="active"><strong aria-hidden="true">6.4.1.</strong> Generic Types</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../directory.html">Index</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../../preface.html">Postface</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Dwarf Programming Language</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/uberfoo/dwarf" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="generic-types"><a class="header" href="#generic-types">Generic Types</a></h1>
<p>Today we're going to talk about how generics are implemented in dwarf.
Generics are a type of polymorphism, which is a way to have one chunk of code work with multiple types.
In the generic code, the abstract type is specified by a single capital letter.
When the code is compiled the abstract type is replaced with a concrete type.
The concrete type is inferred from the call site.</p>
<p>Below are examples of a generic function and a generic type, as well as a usage of each.</p>
<pre><pre class="tunnel"><code class="language-dwarf">// This is a generic function.
// It takes a type T and returns a value of type T + 42.
fn plus_42&lt;T&gt;(x: T) -&gt; T {
    x + 42
}

// This is a generic type.
// It takes a type T and stores a value of type T.
 struct Box&lt;U&gt; {
     value: U,
 }

 impl Box&lt;U&gt; {
     fn display(self) {
         print(&quot;Box&lt;{0}&gt;\n&quot;.format(self.value));
     }
 }

fn main() {
    // Here we call the generic function with an int.
    let x = plus_42(0);
    print(&quot;{0}\n&quot;.format(x));

    // And here with a float.
    let y = plus_42(&quot;Hello World, the answer is &quot;);
    print(&quot;{0}\n&quot;.format(y));

    // Here we create a Box that stores a float.
    let z = Box{ value: 0.42 };
    z.display();

    // Let's box a list now.
    let α = Box{ value: [1, 2, 3] };
    α.display();

    // Let's try something interesting...
    let β = Box{ value: plus_42(&quot;&quot;) };
    β.display();
    print(β);
}</code></pre></pre>
<p>In the examples above notice that the generic labels, <code>T</code> and <code>U</code>, are used in the function and type definitions.
The code in the <code>main</code> function uses the generic function and type with no label to be seen.
That is because concrete types are used in the non-generic, non-definition code.</p>
<h2 id="requirements"><a class="header" href="#requirements">Requirements</a></h2>
<p>So what does it take to make this happen in dwarf?
Well, like everything else, there's a parser piece, an extruder piece, and an interpreter piece.</p>
<p>The <a name="a001"></a>parser reads the input and looks for generic annotations where appropriate.
The <a name="a002"></a>extruder takes the output of the parser and builds the AST, substituting the generic placeholder with a concrete type.
The <a name="a003"></a>interpreter then takes the AST and evaluates it.</p>
<h3 id="parser"><a class="header" href="#parser">Parser</a></h3>
<p>Rather than go into how the parser works, which is covered in the <a href="../arch/parser.html">parser</a> section of the hacker book,</p>
<h3 id="extruder"><a class="header" href="#extruder">Extruder</a></h3>
<h4 id="grace-ast-model"><a class="header" href="#grace-ast-model"><a name="a004"></a>Grace <a name="a005"></a>AST Model</a></h4>
<p>Below is an approximation of (a part of) the model that is used to generate (a part of) the dwarf abstract syntax tree (<a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">AST</a>).
The diagram is UML-ish, and says that <strong>Type</strong> is a supertype, and everything connected by an <strong>R1</strong> label is it's subtype.
<strong>Field</strong> has two relationships, <strong>R3</strong> and <strong>R4</strong>, to <strong>Struct</strong> and <strong>Type</strong> respectively.
These relationships are backed by &quot;referential attributes&quot; whose purpose is to store the relationship data.
In the case of <strong>Field</strong>, <strong>struct</strong> formalizes <strong>R3</strong> and <strong>type</strong> formalizes <strong>R4</strong>.</p>
<p>The points worth reflecting upon are that <strong>Type</strong> is a generalization over all of the dwarf types.
Also, <strong>Field</strong> and <strong>Generic</strong> both have relationships to <strong>Type</strong>. separate from <strong>R1</strong>.</p>
<pre><code class="language-mermaid">classDiagram
    Type &lt;|-- Generic : R1
    Type &lt;|-- Integer : R1
    Type &lt;|-- Struct : R1
    Type &lt;|-- Etcetera : R1
    Generic --&gt; &quot;0..1&quot; Type : R2
    Struct &quot;1&quot; &lt;-- &quot;0..*&quot; Field : R3
    Field --&gt; Type : R4

    class Type
    &lt;&lt;Enumeration&gt;&gt; Type

    class Generic {
        label: String
        *type: Option~R2_Type~
    }

    class Struct {
        name: String
    }

    class Field {
        name: String
        *struct: R3_Struct
        *type: R4_Type
    }
</code></pre>
<p>There is a real model that is much more extensive that is used to generate the AST code.
Below is the generated code for the actual <strong>Type</strong>, called <code>ValueType</code> in the code.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub enum ValueType {
    Char(Uuid),
    Empty(Uuid),
    Enumeration(Uuid),
    Function(Uuid),
    Future(Uuid),
    Generic(Uuid),
    Import(Uuid),
    Lambda(Uuid),
    List(Uuid),
    ObjectStore(Uuid),
    Plugin(Uuid),
    Range(Uuid),
    Struct(Uuid),
    Task(Uuid),
    Ty(Uuid),
    Unknown(Uuid),
}
<span class="boring">}</span></code></pre></pre>
<p>The <code>Ty</code> variant is actually imported from yet another, fundamental, model.
It's definition is below, ond contains what one might expect, given what is missing from above.
These are the fundamental modeling types, whereas above are the dwarf types.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub enum Ty {
    Boolean(Uuid),
    External(Uuid),
    Float(Uuid),
    Integer(Uuid),
    Object(Uuid),
    String(Uuid),
    Uuid(Uuid),
}
<span class="boring">}</span></code></pre></pre>
<pre><pre class="tunnel"><code class="language-dwarf"><span class="boring">#fn main() {
</span>let definition = &quot;
    struct Box&lt;T&gt; {
        value: T,
    }
&quot;;

print(definition);
let ast = chacha::parse(definition);
print(ast);
<span class="boring">}</span></code></pre></pre>
<p>Mention something about assuming the type of a field expression, and then having to use that to check type.</p>
<h3 id="interpreter"><a class="header" href="#interpreter">Interpreter</a></h3>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../hacker/arch/chacha/async.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../directory.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../hacker/arch/chacha/async.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../directory.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../../ace.js"></script>
        <script src="../../editor.js"></script>
        <script src="../../mode-rust.js"></script>
        <script src="../../theme-dawn.js"></script>
        <script src="../../theme-tomorrow_night.js"></script>

        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../mermaid.min.js"></script>
        <script src="../../mermaid-init.js"></script>


    </div>
    </body>
</html>
